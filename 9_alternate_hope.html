<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>District Visualization</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 50px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .legend {
      background: white;
      padding: 6px 8px;
      font-size: 14px;
      line-height: 18px;
      color: #555;
      border-radius: 5px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label for="district">Enter District: </label>
    <input type="text" id="district" placeholder="Faridabad">
    <button onclick="loadDistrict()">Load</button>
    <br><br>

    <b>Visualize by:</b><br>
    <!-- <label><input type="checkbox" name="attr" value="landcove_1"> Landcover</label><br> -->
    <label><input type="checkbox" name="attr" value="lighting_r"> Lighting</label><br>
    <label><input type="checkbox" name="attr" value="lst_celsiu"> LST (°C)</label><br>
    <label><input type="checkbox" name="attr" value="no2"> NO₂</label><br>
    <label><input type="checkbox" name="attr" value="uhi_intens"> UHI Intensity</label><br>
    <button id="overallBtn" style="margin-top:10px;">Show Overall Rating</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([28.4, 77.3], 8);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    let districtLayer;
    let currentData = [];
    let showOverall = false; // ✅ track mode

    // --- COLOR FUNCTIONS ---
    function getColor(value, attr) {
      if (!value) return "#cccccc";

      value = parseFloat(value);
      switch (attr) {
        case "lighting_r":
          return value > 20 ? "#800026" :
                 value > 15 ? "#BD0026" :
                 value > 10 ? "#E31A1C" :
                 value > 5  ? "#FD8D3C" : "#FED976";
        case "lst_celsiu":
          return value > 30 ? "#800026" :
                 value > 28 ? "#BD0026" :
                 value > 26 ? "#E31A1C" :
                 value > 24 ? "#FD8D3C" : "#FED976";
        case "no2":
          return value > 0.00015 ? "#800026" :
                 value > 0.00012 ? "#BD0026" :
                 value > 0.0001  ? "#E31A1C" :
                 value > 0.00008 ? "#FD8D3C" : "#FED976";
        case "uhi_intens":
          return value > 2 ? "#800026" :
                 value > 1 ? "#E31A1C" :
                 value > 0 ? "#FD8D3C" : "#FED976";
        case "landcove_1":
          const lcColors = {
            "Trees": "#228B22",
            "Built area": "#B22222",
            "Water": "#1E90FF",
            "Crops": "#DAA520"
          };
          return lcColors[value] || "#cccccc";
        default:
          return "#cccccc";
      }
    }

    // --- OVERALL SCORE CALCULATION ---
    function calculateOverallScore(props) {
      const weights = {
        lighting_r: 0.2,
        lst_celsiu: 0.25,
        no2: 0.25,
        uhi_intens: 0.2,
        landcove_1: 0.1
      };

      let score = 0;
      let totalWeight = 0;

      if (props.lighting_r) {
        score += (1 - Math.min(props.lighting_r / 25, 1)) * weights.lighting_r;
        totalWeight += weights.lighting_r;
      }

      if (props.lst_celsiu) {
        score += (1 - Math.min((props.lst_celsiu - 20) / 15, 1)) * weights.lst_celsiu;
        totalWeight += weights.lst_celsiu;
      }

      if (props.no2) {
        score += (1 - Math.min(props.no2 / 0.00015, 1)) * weights.no2;
        totalWeight += weights.no2;
      }

      if (props.uhi_intens !== undefined) {
        score += (1 - Math.min(props.uhi_intens / 3, 1)) * weights.uhi_intens;
        totalWeight += weights.uhi_intens;
      }

      if (props.landcove_1) {
        let boost = 0;
        if (props.landcove_1 === "Trees" || props.landcove_1 === "Crops") boost = 1;
        else if (props.landcove_1 === "Water") boost = 0.8;
        else boost = 0.3;
        score += boost * weights.landcove_1;
        totalWeight += weights.landcove_1;
      }

      return score / totalWeight;
    }

    function getOverallColor(score) {
      return score > 0.8 ? "#006837" :
             score > 0.6 ? "#31a354" :
             score > 0.4 ? "#addd8e" :
             score > 0.2 ? "#fdae61" :
                            "#d73027";
    }

    // --- STYLE FUNCTION ---
    function styleFeature(feature) {
      const selectedAttr = getSelectedAttribute();
      if (showOverall) {
        const score = feature.properties._overall_score;
        return {
          color: "#000",
          weight: 1,
          fillColor: getOverallColor(score),
          fillOpacity: 0.7
        };
      }

      const value = selectedAttr ? feature.properties[selectedAttr] : null;
      return {
        color: "#000",
        weight: 1,
        fillColor: getColor(value, selectedAttr),
        fillOpacity: 0.6
      };
    }

    function getSelectedAttribute() {
      const checked = document.querySelector("input[name='attr']:checked");
      return checked ? checked.value : null;
    }

    function renderLayer() {
      if (districtLayer) map.removeLayer(districtLayer);

      const features = currentData
        .filter(item => item.geometry)
        .map(item => {
          const feature = {
            type: "Feature",
            geometry: item.geometry,
            properties: item
          };
          feature.properties._overall_score = calculateOverallScore(item);
          return feature;
        });

      districtLayer = L.geoJSON(features, {
        style: styleFeature,
        onEachFeature: (feature, layer) => {
          let props = feature.properties;
          let popupHTML = Object.entries(props)
            .filter(([k]) => !k.startsWith("_"))
            .map(([k, v]) => `<b>${k}</b>: ${v}`)
            .join("<br>");
          popupHTML += `<br><b>Overall Score:</b> ${(props._overall_score * 100).toFixed(1)}%`;
          layer.bindPopup(popupHTML);
        }
      }).addTo(map);

      try {
        map.fitBounds(districtLayer.getBounds());
      } catch (e) {
        console.warn("⚠️ Could not fit bounds:", e);
      }
    }

    function loadDistrict() {
      const district = document.getElementById("district").value;
      if (!district) {
        alert("Please enter a district name");
        return;
      }

      fetch(`/get_district_data?district=${district}`)
        .then(res => res.json())
        .then(data => {
          console.log("✅ API returned:", data);
          currentData = data;
          renderLayer();
        })
        .catch(err => {
          console.error("❌ Error loading district:", err);
          alert("Failed to fetch data.");
        });
    }

    // --- Checkbox handling ---
    document.querySelectorAll("input[name='attr']").forEach(cb => {
      cb.addEventListener("change", () => {
        showOverall = false; // disable overall mode
        document.querySelectorAll("input[name='attr']").forEach(other => {
          if (other !== cb) other.checked = false;
        });
        renderLayer();
      });
    });

    // --- Overall Rating Button ---
    document.getElementById("overallBtn").addEventListener("click", () => {
      document.querySelectorAll("input[name='attr']").forEach(cb => cb.checked = false);
      showOverall = true;
      renderLayer();
    });

    // --- LEGEND ---
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      const grades = [0, 0.2, 0.4, 0.6, 0.8];
      const labels = ["Very Poor", "Poor", "Average", "Good", "Excellent"];
      for (let i = 0; i < grades.length; i++) {
        const from = grades[i];
        div.innerHTML +=
          `<i style="background:${getOverallColor(from + 0.1)}"></i> ${labels[i]}<br>`;
      }
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
